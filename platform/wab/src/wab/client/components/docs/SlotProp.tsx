import { ensureKnownTplTag } from "@/wab/shared/model/classes";
// This is a skeleton starter React component generated by Plasmic.
// This file is owned by you, feel free to edit as you see fit.
import { DocsPortalCtx } from "@/wab/client/components/docs/DocsPortalCtx";
import { Icon } from "@/wab/client/components/widgets/Icon";
import IconButton from "@/wab/client/components/widgets/IconButton";
import Textbox from "@/wab/client/components/widgets/Textbox";
import CloseIcon from "@/wab/client/plasmic/plasmic_kit/PlasmicIcon__Close";
import { PlasmicSlotProp } from "@/wab/client/plasmic/plasmic_kit_docs_portal/PlasmicSlotProp";
import { isPlainTextTplSlot } from "@/wab/shared/SlotUtils";
import { tryGetBaseVariantSetting } from "@/wab/shared/Variants";
import { toVarName } from "@/wab/shared/codegen/util";
import { ensure } from "@/wab/shared/common";
import { getRichTextContent } from "@/wab/shared/core/tpls";
import { TplSlot } from "@/wab/shared/model/classes";
import { observer } from "mobx-react";
import * as React from "react";

interface SlotPropProps {
  docsCtx: DocsPortalCtx;
  slot: TplSlot;
}

const SlotProp = observer(function SlotProp(props: SlotPropProps) {
  const { docsCtx, slot } = props;
  const param = slot.param;
  const name = toVarName(param.variable.name);
  const component = docsCtx.getFocusedComponent();
  const isText = isPlainTextTplSlot(slot);
  const value = docsCtx.getComponentToggle(component, param) as
    | string
    | undefined;
  return (
    <PlasmicSlotProp label={name} isNonText={!isText}>
      {isText && (
        <Textbox
          placeholder={getDefaultText(slot, docsCtx)}
          value={value ?? ""}
          onChange={(e) =>
            docsCtx.setComponentToggle(component, param, e.target.value)
          }
          withIcons={["withSuffix"]}
          suffixIcon={
            !!value && (
              <IconButton
                type="seamless"
                onClick={() =>
                  docsCtx.setComponentToggle(component, param, undefined)
                }
              >
                <Icon icon={CloseIcon} />
              </IconButton>
            )
          }
          styleType={"bordered"}
        />
      )}
    </PlasmicSlotProp>
  );
});

function getDefaultText(slot: TplSlot, docsCtx: DocsPortalCtx) {
  const textNode = ensureKnownTplTag(slot.defaultContents[0]);
  const vs = ensure(tryGetBaseVariantSetting(textNode));
  const viewCtx = ensure(
    docsCtx.studioCtx.focusedOrFirstViewCtx(),
    "Missing viewCtx in docs portal"
  );
  return vs.text ? getRichTextContent(vs.text, viewCtx) : "";
}

export default SlotProp;
