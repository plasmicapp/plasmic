// This is a skeleton starter React component generated by Plasmic.
// This file is owned by you, feel free to edit as you see fit.
import CmsEntryItem from "@/wab/client/components/cms/CmsEntryItem";
import {
  useCmsTable,
  useMutateTableRows,
} from "@/wab/client/components/cms/cms-contexts";
import { Spinner } from "@/wab/client/components/widgets";
import { useApi } from "@/wab/client/contexts/AppContexts";
import {
  DefaultCmsEntriesListProps,
  PlasmicCmsEntriesList,
} from "@/wab/client/plasmic/plasmic_kit_cms/PlasmicCmsEntriesList";
import { ApiCmseRow, CmsDatabaseId, CmsTableId } from "@/wab/shared/ApiSchema";
import { APP_ROUTES } from "@/wab/shared/route/app-routes";
import { fillRoute } from "@/wab/shared/route/route";
import { naturalSort } from "@/wab/shared/sort";
import { HTMLElementRefOf } from "@plasmicapp/react-web";
import { Dropdown, Menu } from "antd";
import fastStringify from "fast-stringify";
import { debounce } from "lodash";
import * as React from "react";
import { useHistory, useRouteMatch } from "react-router";

interface SortConfig {
  key: string;
  label: string;
  sortFn: (rows: ApiCmseRow[]) => ApiCmseRow[];
}

const LAST_CREATED_SORT: SortConfig = {
  key: "last-created",
  label: "Last created",
  sortFn: (rows) =>
    [...rows].sort(
      (a, b) =>
        new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
    ),
};

const FIRST_CREATED_SORT: SortConfig = {
  key: "first-created",
  label: "First created",
  sortFn: (rows) =>
    [...rows].sort(
      (a, b) =>
        new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime()
    ),
};

const LAST_UPDATED_SORT: SortConfig = {
  key: "last-updated",
  label: "Last updated",
  sortFn: (rows) =>
    [...rows].sort(
      (a, b) =>
        new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime()
    ),
};

const FIRST_UPDATED_SORT: SortConfig = {
  key: "first-updated",
  label: "First updated",
  sortFn: (rows) =>
    [...rows].sort(
      (a, b) =>
        new Date(a.updatedAt).getTime() - new Date(b.updatedAt).getTime()
    ),
};

const IDENTIFIER_A_Z_SORT: SortConfig = {
  key: "identifier-a-z",
  label: "Identifier (A-Z)",
  sortFn: (rows) => naturalSort(rows, (row) => row.identifier ?? ""),
};

const IDENTIFIER_Z_A_SORT: SortConfig = {
  key: "identifier-z-a",
  label: "Identifier (Z-A)",
  sortFn: (rows) => naturalSort(rows, (row) => row.identifier ?? "").reverse(),
};

const SORT_CONFIGS: SortConfig[] = [
  LAST_CREATED_SORT,
  FIRST_CREATED_SORT,
  LAST_UPDATED_SORT,
  FIRST_UPDATED_SORT,
  IDENTIFIER_A_Z_SORT,
  IDENTIFIER_Z_A_SORT,
];

export interface CmsEntriesListProps extends DefaultCmsEntriesListProps {
  rows?: ApiCmseRow[];
}

function CmsEntriesList_(
  props: CmsEntriesListProps,
  ref: HTMLElementRefOf<"div">
) {
  const { rows, ...rest } = props;
  const api = useApi();
  const history = useHistory();
  const match = useRouteMatch<{
    databaseId: CmsDatabaseId;
    tableId: CmsTableId;
  }>();
  const { databaseId, tableId } = match.params;
  const table = useCmsTable(databaseId, tableId);
  const mutateTableRows = useMutateTableRows();
  const [query, setQuery] = React.useState("");
  const [debouncedQuery, setDebouncedQuery] = React.useState("");
  const [sortConfig, setSortConfig] =
    React.useState<SortConfig>(LAST_CREATED_SORT);

  const sortedAndFilteredRows = React.useMemo(() => {
    if (!rows) {
      return [];
    }
    const hasQuery = !!debouncedQuery && debouncedQuery.trim().length > 0;
    const normQuery = debouncedQuery.toLowerCase();
    const filtered = hasQuery
      ? rows?.filter((row) =>
          fastStringify(Object.values(row)).toLowerCase().includes(normQuery)
        )
      : rows;

    return sortConfig.sortFn(filtered);
  }, [rows, debouncedQuery, sortConfig]);

  const debouncedSetQuery = React.useCallback(
    debounce((q: string) => {
      setDebouncedQuery(q);
    }, 300),
    [setDebouncedQuery]
  );

  if (!rows || !table) {
    return <Spinner />;
  }

  return (
    <PlasmicCmsEntriesList
      {...rest}
      root={{ ref }}
      modelName={table.name}
      searchInput={{
        value: query,
        onChange: (e) => {
          setQuery(e.target.value);
          debouncedSetQuery(e.target.value);
        },
      }}
      children={
        <>
          {sortedAndFilteredRows.map((row) => (
            <CmsEntryItem table={table} row={row} key={row.id} />
          ))}
        </>
      }
      sortButton={{
        wrap: (node) => (
          <Dropdown
            overlay={
              <Menu selectedKeys={[sortConfig.key]}>
                {SORT_CONFIGS.map((config) => (
                  <Menu.Item
                    key={config.key}
                    onClick={() => setSortConfig(config)}
                  >
                    {config.label}
                  </Menu.Item>
                ))}
              </Menu>
            }
          >
            {node}
          </Dropdown>
        ),
      }}
      addButton={{
        tooltip: "Add new entry",
        "data-test-id": "addEntryButton",
        onClick: async () => {
          const row = await api.createCmsRow(tableId, {
            identifier: undefined,
            data: null,
            draftData: { "": {} },
          });
          await mutateTableRows(tableId);
          history.push(
            fillRoute(APP_ROUTES.cmsEntry, {
              databaseId,
              tableId,
              rowId: row.id,
            })
          );
        },
      }}
    />
  );
}

const CmsEntriesList = React.forwardRef(CmsEntriesList_);
export default CmsEntriesList;
