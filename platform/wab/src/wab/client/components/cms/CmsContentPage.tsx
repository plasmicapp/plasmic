// This is a skeleton starter React component generated by Plasmic.
// This file is owned by you, feel free to edit as you see fit.
import { useRRouteMatch } from "@/wab/client/cli-routes";
import { useCmsDatabase } from "@/wab/client/components/cms/cms-contexts";
import {
  DefaultCmsContentPageProps,
  PlasmicCmsContentPage,
} from "@/wab/client/plasmic/plasmic_kit_cms/PlasmicCmsContentPage";
import { APP_ROUTES } from "@/wab/shared/route/app-routes";
import { fillRoute } from "@/wab/shared/route/route";
import { HTMLElementRefOf } from "@plasmicapp/react-web";
import * as React from "react";
import { Redirect, Route, Switch } from "react-router";

export type CmsContentPageProps = DefaultCmsContentPageProps;

function CmsContentPage_(
  props: CmsContentPageProps,
  ref: HTMLElementRefOf<"div">
) {
  const m = useRRouteMatch(APP_ROUTES.cmsContentRoot);
  const database = useCmsDatabase(m?.params.databaseId);
  if (!m || !database) {
    return null;
  }

  // Sort to make archived tables last on the list
  // Sorting by id to make it stable.
  const tables = database.tables.sort((a, b) =>
    a.isArchived == b.isArchived
      ? b.id.localeCompare(a.id)
      : a.isArchived
      ? 1
      : -1
  );
  return (
    <Switch>
      <Route
        path={APP_ROUTES.cmsModelContent.pattern}
        render={({ match }) => {
          if (!tables.find((t) => t.id === match.params.tableId)) {
            return (
              <Redirect
                to={fillRoute(APP_ROUTES.cmsContentRoot, {
                  databaseId: match.params.databaseId,
                })}
              />
            );
          } else {
            return <PlasmicCmsContentPage root={{ ref }} {...props} />;
          }
        }}
      />
      <Route
        path={APP_ROUTES.cmsContentRoot.pattern}
        render={() => {
          if (tables.length > 0) {
            return (
              <Redirect
                to={fillRoute(APP_ROUTES.cmsModelContent, {
                  databaseId: database.id,
                  tableId: tables[0].id,
                })}
              />
            );
          } else {
            return (
              <PlasmicCmsContentPage
                noModels={true}
                root={{ ref }}
                {...props}
              />
            );
          }
        }}
      />
    </Switch>
  );
}

const CmsContentPage = React.forwardRef(CmsContentPage_);
export default CmsContentPage;
