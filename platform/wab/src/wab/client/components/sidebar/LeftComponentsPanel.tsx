// This is a skeleton starter React component generated by Plasmic.
// This file is owned by you, feel free to edit as you see fit.
import {
  VirtualTree,
  RenderElementProps,
  useTreeData,
} from "@/wab/client/components/grouping/VirtualTree";
import { ComponentFolderRow } from "@/wab/client/components/sidebar/ComponentFolderRow";
import { ComponentRow } from "@/wab/client/components/sidebar/ComponentRow";
import { PlasmicLeftComponentsPanel } from "@/wab/client/plasmic/plasmic_kit_left_pane/PlasmicLeftComponentsPanel";
import { useStudioCtx } from "@/wab/client/studio-ctx/StudioCtx";
import { isBuiltinCodeComponent } from "@/wab/shared/code-components/builtin-code-components";
import { isNonNil, unreachable } from "@/wab/shared/common";
import {
  getComponentDisplayName,
  getFolderComponentTrimmedName,
  isCodeComponent,
  isContextCodeComponent,
  isHostLessCodeComponent,
  isPageComponent,
  isReusableComponent,
  isShownHostLessCodeComponent,
  sortComponentsByName,
} from "@/wab/shared/core/components";
import { isHostLessPackage } from "@/wab/shared/core/sites";
import { isAdminTeamEmail } from "@/wab/shared/devflag-utils";
import {
  Folder as InternalFolder,
  createFolderTreeStructure,
  isFolder,
} from "@/wab/shared/folders/folders-util";
import { Component, ProjectDependency } from "@/wab/shared/model/classes";
import { naturalSort } from "@/wab/shared/sort";
import { debounce } from "lodash";
import { observer } from "mobx-react";
import * as React from "react";

interface Folder {
  type: "folder" | "folder-component";
  name: string;
  key: string;
  items: ComponentPanelRow[];
  count: number;
}

interface ComponentData {
  type: "component";
  key: string;
  component: Component;
  importedFrom?: string;
}

type ComponentPanelRow = Folder | ComponentData;

function mapToComponentPanelRow(
  item: Component | InternalFolder<Component>,
  dep?: ProjectDependency
): ComponentPanelRow {
  if (!isFolder(item)) {
    return {
      type: "component" as const,
      key: item.uuid,
      component: item,
      importedFrom: dep?.projectId,
    };
  }

  return {
    type: "folder-component" as const,
    key: item.path,
    name: item.name,
    items: item.items.map((i) => mapToComponentPanelRow(i, dep)),
    count: item.count,
  };
}

const LeftComponentsPanel = observer(function LeftComponentsPanel() {
  const studioCtx = useStudioCtx();
  const [debouncedQuery, setDebouncedQuery] = React.useState("");
  const debouncedSetQuery = React.useCallback(
    debounce((value: string) => {
      setDebouncedQuery(value);
    }, 500),
    [setDebouncedQuery]
  );
  const getRowKey = React.useCallback((row: ComponentPanelRow) => {
    return row.key;
  }, []);
  const getRowChildren = React.useCallback((row: ComponentPanelRow) => {
    if (row.type === "component") {
      return [];
    }
    return row.items;
  }, []);
  const getRowSearchText = React.useCallback((row: ComponentPanelRow) => {
    if (row.type === "component") {
      return getComponentDisplayName(row.component);
    }
    return row.name;
  }, []);
  const getRowHeight = React.useCallback(() => {
    return 32;
  }, []);

  const readOnly = studioCtx.getLeftTabPermission("components") === "readable";

  const isAdmin = isAdminTeamEmail(
    studioCtx.appCtx.selfInfo?.email,
    studioCtx.appCtx.appConfig
  );

  const makeCompsItems = (
    comps: Component[],
    pathPrefix: string,
    dep?: ProjectDependency
  ): { items: ComponentPanelRow[]; count: number } => {
    comps = comps.filter(
      (comp) =>
        isReusableComponent(comp) &&
        !isBuiltinCodeComponent(comp) &&
        !isContextCodeComponent(comp) &&
        (!isHostLessCodeComponent(comp) ||
          isShownHostLessCodeComponent(
            comp,
            studioCtx.appCtx.appConfig.hostLessComponents
          ))
    );
    comps = sortComponentsByName(comps);
    const componentTree = createFolderTreeStructure(comps, {
      pathPrefix,
      getName: (item) => getFolderComponentTrimmedName(item),
      mapper: (item) => mapToComponentPanelRow(item, dep),
    });

    return { items: componentTree, count: comps.length };
  };

  const makeDepsItems = (deps: ProjectDependency[]): Folder[] => {
    deps = naturalSort(deps, (dep) =>
      studioCtx.projectDependencyManager.getNiceDepName(dep)
    );

    return deps
      .map((dep) => {
        const { items, count } = makeCompsItems(
          dep.site.components.filter(
            (c) =>
              isReusableComponent(c) &&
              (isHostLessPackage(dep.site) || !isCodeComponent(c))
          ),
          `${dep.uuid}-`,
          dep
        );
        return {
          type: "folder" as const,
          name: `${studioCtx.projectDependencyManager.getNiceDepName(dep)}`,
          key: dep.uuid,
          // For deps, we only show code components from hostless packages; for non-hostless
          // packages, ony the code components from the current host page count, and they're
          // shown in the Code components section
          items: items,
          count: count,
        };
      })
      .filter((folder) => folder.count > 0);
  };

  const plainComponents = studioCtx.site.components.filter(
    (c) => isReusableComponent(c) && !isCodeComponent(c)
  );
  const codeComponents = studioCtx.site.components.filter(
    (c) =>
      isReusableComponent(c) &&
      isCodeComponent(c) &&
      !isHostLessCodeComponent(c) &&
      !isContextCodeComponent(c)
  );

  // Show non-hostless packages first, then hostless packages
  const importedComponentItems = [
    ...makeDepsItems(
      studioCtx.site.projectDependencies.filter(
        (d) => !isHostLessPackage(d.site)
      )
    ),
    ...makeDepsItems(
      studioCtx.site.projectDependencies.filter((d) =>
        isHostLessPackage(d.site)
      )
    ),
  ].filter((folder) => folder.count > 0);

  const items: ComponentPanelRow[] = [
    ...makeCompsItems(plainComponents, "").items,
    ...(codeComponents.length > 0
      ? [
          {
            type: "folder" as const,
            name: "Code components",
            key: `$code-components-folder`,
            ...makeCompsItems(codeComponents, "$code-components-folder-"),
          },
        ]
      : []),
    ...(importedComponentItems.length > 0
      ? [
          {
            type: "folder" as const,
            name: "Imported",
            key: "$imports-folder",
            items: importedComponentItems,
            count: importedComponentItems.reduce(
              (sum, folder) => sum + folder.count,
              0
            ),
          },
        ]
      : []),
    ...(isAdmin
      ? studioCtx.site.projectDependencies
          .filter((d) => !isHostLessPackage(d.site))
          .map((dep) => {
            const pageComponents = sortComponentsByName(dep.site.components)
              .filter((c) => isPageComponent(c))
              .map((comp) => ({
                type: "component" as const,
                component: comp,
                key: comp.uuid,
                importedFrom: dep.projectId,
              }));
            if (pageComponents.length === 0) {
              return undefined;
            }
            return {
              type: "folder" as const,
              name: `PAGES FROM ${dep.name} (DO NOT USE)`,
              key: `$pages-${dep.uuid}`,
              // For deps, we only show code components from hostless packages; for non-hostless
              // packages, ony the code components from the current host page count, and they're
              // shown in the Code components section
              items: pageComponents,
              count: pageComponents.length,
            } as Folder;
          })
          .filter(isNonNil)
      : []),
  ];

  const { nodeData, nodeKey, nodeHeights, expandAll, collapseAll } =
    useTreeData<ComponentPanelRow>({
      nodes: items,
      query: debouncedQuery,
      renderElement: ComponentTreeRow,
      getNodeKey: getRowKey,
      getNodeChildren: getRowChildren,
      getNodeSearchText: getRowSearchText,
      getNodeHeight: getRowHeight,
      defaultOpenKeys: "all",
    });

  return (
    <PlasmicLeftComponentsPanel
      root={{
        props: {
          "data-test-id": "components-tab",
        } as any,
      }}
      leftSearchPanel={{
        searchboxProps: {
          onChange: (e) => {
            debouncedSetQuery(e.target.value);
          },
          autoFocus: true,
        },
      }}
      newComponentButton={
        readOnly
          ? { render: () => null }
          : {
              onClick: () => studioCtx.siteOps().createFrameForNewComponent(),
            }
      }
      content={
        <>
          <VirtualTree
            rootNodes={items}
            renderElement={ComponentTreeRow}
            nodeData={nodeData}
            nodeKey={nodeKey}
            nodeHeights={nodeHeights}
            expandAll={expandAll}
            collapseAll={collapseAll}
          />
        </>
      }
    />
  );
});

const ComponentTreeRow = (props: RenderElementProps<ComponentPanelRow>) => {
  const { value, treeState } = props;
  switch (value.type) {
    case "folder":
    case "folder-component":
      return (
        <ComponentFolderRow
          name={value.name}
          matcher={treeState.matcher}
          isOpen={treeState.isOpen}
          groupSize={value.count}
          indentMultiplier={treeState.level}
        />
      );
    case "component":
      return (
        <ComponentRow
          component={value.component}
          matcher={treeState.matcher}
          importedFrom={value.importedFrom}
          indentMultiplier={treeState.level}
        />
      );
    default:
      unreachable(value);
  }
};

export default LeftComponentsPanel;
