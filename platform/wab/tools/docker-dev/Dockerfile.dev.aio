# --- Build stage ---
FROM node:24-alpine AS builder

WORKDIR /plasmic

# Install system deps
RUN apk add --no-cache \
    bash \
    git \
    curl \
    wget \
    python3 \
    py3-pip \
    postgresql-client \
    build-base

# Copy all source files first (needed for yarn workspaces)
COPY . .

# Install all workspace dependencies
RUN yarn install --frozen-lockfile

# Secrets setup and build tools
RUN mkdir -p /tmp/.plasmic && \
    cp platform/wab/tools/docker-dev/secrets.json /tmp/.plasmic/secrets.json && \
    yarn setup && \
    yarn setup:canvas-packages

# Install dependencies for all sub-packages used by dev server
RUN cd platform/sub && yarn --frozen-lockfile && \
    cd ../canvas-packages && yarn --frozen-lockfile && \
    cd ../react-web-bundle && yarn --frozen-lockfile && \
    cd ../live-frame && yarn --frozen-lockfile && \
    cd ../loader-html-hydrate && yarn --frozen-lockfile

# Clean yarn cache to reduce image size
RUN yarn cache clean

# --- Final stage ---
FROM node:24-alpine

# Create non-root user and prepare env
RUN addgroup -S plasmic && \
    adduser -S plasmic -G plasmic && \
    apk add --no-cache git jq bash && \
    echo "fs.inotify.max_user_watches=524288" >> /etc/sysctl.conf && \
    sysctl -p && \
    mkdir -p $HOME && \
    chown -R plasmic:plasmic $HOME

USER plasmic

WORKDIR /plasmic/platform/wab

# Copy built app and secrets with correct ownership
COPY --chown=plasmic:plasmic --from=builder /plasmic /plasmic
COPY --chown=plasmic:plasmic --from=builder /tmp/.plasmic /home/plasmic/.plasmic

# Fix git ownership check issue (required for rsbuild config)
RUN git config --global --add safe.directory /plasmic

EXPOSE 3003 3004 3005

ENTRYPOINT ["sh", "-c"]
CMD [" jq '(.host = \"plasmic-db\") | (.password //= \"SEKRET\")' ormconfig.json > tmp.json && mv tmp.json ormconfig.json && \
    yarn typeorm migration:run && \
    yarn seed && \
    cd /plasmic && \
    yarn dev \
"]